# 📚 Manga Repository Documentation

Documentation for individual manga repository structure and automation.

**Example Repository:** `YarikondaRenaiGame`

---

## 📂 Repository Structure

```
YarikondaRenaiGame/
├── manga.json                      # ⚙️ Auto-generated manga data
├── manga-config.json               # 📝 Manual configuration
├── pending-views.json              # 📊 Pending page views counter
├── pending-chapter-views.json      # 📖 Pending chapter views counter
│
├── manga-automation.js             # 🤖 Automation script
├── .github/
│   └── workflows/
│       └── manga-automation.yml    # 🔄 GitHub Actions workflow
│
└── [Chapter Folders]/              # 📁 Chapter content
    ├── 1/
    │   ├── Image01.jpg
    │   ├── Image02.jpg
    │   └── ...
    ├── 2.1/
    ├── 2.2/
    └── ...
```

---

## 📄 File Descriptions

### 1. `manga-config.json` 📝

**Purpose:** Manual configuration file - the only file you need to edit manually.

**Contains:**
- Manga metadata (title, author, artist, description)
- Cover image URL
- Genre, status
- Links (MangaDex, raw source)
- Repository settings (owner, name, image format)
- **Locked chapters list**

**Example:**
```json
{
  "title": "Yarikonda Renai Game...",
  "alternativeTitle": "やり込んだ恋愛ゲーム...",
  "cover": "https://raw.githubusercontent.com/.../cover.jpg",
  "description": "Manga description...",
  "author": "Kennoji",
  "artist": "Yuuma Yun",
  "genre": ["Seinen", "Comedy", "Romance"],
  "status": "Ongoing",
  "lockedChapters": ["6.2", "6.3", "6.4", "6.5"],
  "repoOwner": "nurananto",
  "repoName": "YarikondaRenaiGame",
  "imagePrefix": "Image",
  "imageFormat": "jpg"
}
```

**When to Edit:**
- When adding new manga information
- When locking/unlocking chapters
- When updating metadata

---

### 2. `manga.json` ⚙️

**Purpose:** Auto-generated complete manga data file.

**Generated By:** `manga-automation.js generate`

**Contains:**
- All manga metadata from `manga-config.json`
- Complete chapter list with details:
  - Title, folder name, page count
  - Upload date (from Git history)
  - Lock status
  - View counts
- Last update timestamps

**Example Structure:**
```json
{
  "manga": {
    "title": "...",
    "views": 0,
    "...": "..."
  },
  "chapters": {
    "1": {
      "title": "Chapter 1",
      "folder": "1",
      "uploadDate": "2025-09-26T...",
      "totalPages": 81,
      "locked": false,
      "views": 0
    },
    "6.5": {
      "title": "Chapter 6.5",
      "folder": "6.5",
      "uploadDate": "2025-10-26T...",
      "totalPages": 0,
      "locked": true,
      "views": 0
    }
  },
  "lastUpdated": "2025-10-29T15:23:31.437Z",
  "lastChapterUpdate": "2025-10-26"
}
```

**⚠️ Do NOT Edit Manually** - This file is auto-generated and will be overwritten.

---

### 3. `pending-views.json` 📊

**Purpose:** Track pending page views (manga info page).

**Updated By:** Google Apps Script when users visit `info-manga.html`

**Structure:**
```json
{
  "pendingViews": 0,
  "lastIncrement": "2025-10-24T00:00:00.000Z",
  "lastUpdate": "2025-10-24T00:00:00.000Z"
}
```

**How it Works:**
1. User visits info page → Google Apps Script increments `pendingViews`
2. When `pendingViews >= 20` → Automation adds to `manga.json` views
3. Reset `pendingViews` to 0

**Threshold:** 20 views

---

### 4. `pending-chapter-views.json` 📖

**Purpose:** Track pending chapter views (individual chapters).

**Updated By:** 
- Google Apps Script (when users view chapters)
- `manga-automation.js sync` (adds new chapters)

**Structure:**
```json
{
  "chapters": {
    "1": {
      "pendingViews": 0,
      "lastIncrement": "2025-10-23T18:07:30.298Z",
      "lastUpdate": "2025-10-23T18:07:30.298Z"
    },
    "6.5": {
      "pendingViews": 0,
      "lastIncrement": "2025-10-23T18:07:30.299Z",
      "lastUpdate": "2025-10-23T18:07:30.299Z"
    }
  },
  "lastUpdated": "2025-10-29T15:23:31.484Z"
}
```

**How it Works:**
1. User views chapter → Google Apps Script increments chapter's `pendingViews`
2. When `pendingViews >= 10` → Automation adds to chapter views in `manga.json`
3. Reset chapter's `pendingViews` to 0

**Threshold:** 10 views per chapter

**Note:** Locked chapters also track views (to measure interest).

---

### 5. `manga-automation.js` 🤖

**Purpose:** Node.js script for manga automation tasks.

**Commands:**

#### `node manga-automation.js generate`
- Scans chapter folders
- Generates/updates `manga.json`
- Counts images in each folder
- Gets upload dates from Git history
- **Locked chapter date logic:**
  - All locked chapters use the upload date of the **latest unlocked chapter**
  - When you upload a new chapter, all locked chapters automatically update their dates

**Example:**
```bash
# You upload chapter 6.4 on Oct 25
# Locked chapter 6.5 automatically gets Oct 25 as uploadDate
```

#### `node manga-automation.js sync`
- Syncs chapters between `manga.json` and `pending-chapter-views.json`
- Adds new chapters to pending views tracking

#### `node manga-automation.js update-views`
- Checks `pending-views.json`
- If `pendingViews >= 20`:
  - Add to `manga.json` manga views
  - Reset `pendingViews` to 0

#### `node manga-automation.js update-chapters`
- Checks `pending-chapter-views.json`
- For each chapter with `pendingViews >= 10`:
  - Add to chapter views in `manga.json`
  - Reset chapter's `pendingViews` to 0

---

### 6. `manga-automation.yml` 🔄

**Purpose:** GitHub Actions workflow for automatic updates.

**Location:** `.github/workflows/manga-automation.yml`

**Triggers:**
- **Push** to main branch (new chapter upload)
- **Schedule** (daily at midnight UTC)
- **Manual** workflow dispatch

**Steps:**
1. Generate `manga.json`
2. Sync chapters
3. Update manga views (if threshold reached)
4. Update chapter views (if threshold reached)
5. Commit and push changes

**Auto-commit Messages:**
- Push trigger: "📚 Auto-update manga data [skip ci]"
- Schedule trigger: "📊 Daily refresh [skip ci]"
- Manual trigger: "🔄 Manual update [skip ci]"

---

## 🔄 Workflow

### Adding New Chapter

1. **Create chapter folder:**
   ```
   mkdir 6.6
   ```

2. **Add images:**
   ```
   6.6/
   ├── Image01.jpg
   ├── Image02.jpg
   └── ...
   ```

3. **Commit and push:**
   ```bash
   git add 6.6/
   git commit -m "Add chapter 6.6"
   git push
   ```

4. **Automation runs automatically:**
   - Detects new folder
   - Updates `manga.json`
   - Syncs `pending-chapter-views.json`
   - **Updates all locked chapters' uploadDate** to match this new chapter

### Locking/Unlocking Chapter

1. **Edit `manga-config.json`:**
   ```json
   {
     "lockedChapters": ["6.5", "6.6", "6.7"]
   }
   ```

2. **Commit and push:**
   ```bash
   git add manga-config.json
   git commit -m "Lock chapters 6.5-6.7"
   git push
   ```

3. **Automation updates `manga.json`** automatically

---

## 📊 View Tracking Flow

### Page Views
```
User visits info-manga.html
         ↓
Google Apps Script (POST request)
         ↓
pending-views.json: pendingViews++
         ↓
If pendingViews >= 20:
         ↓
GitHub Actions (daily check)
         ↓
manga.json: manga.views += pendingViews
         ↓
pending-views.json: pendingViews = 0
```

### Chapter Views
```
User reads chapter in reader.html
         ↓
Google Apps Script (POST request)
         ↓
pending-chapter-views.json: chapters[X].pendingViews++
         ↓
If pendingViews >= 10:
         ↓
GitHub Actions (daily check)
         ↓
manga.json: chapters[X].views += pendingViews
         ↓
pending-chapter-views.json: chapters[X].pendingViews = 0
```

---

## 🔒 Locked Chapter Logic

**Upload Date Behavior:**

All locked chapters always use the **latest unlocked chapter's upload date**.

**Example Scenario:**

| Action | Date | Result |
|--------|------|--------|
| Upload 6.3 | Oct 19 | Lock 6.4, 6.5 → both get Oct 19 |
| Upload 6.4 | Oct 25 | Lock 6.5 → gets Oct 25 (auto-updated!) |
| Upload 6.6 | Oct 30 | Lock 6.5 → stays Oct 25 (6.5 was unlocked) |

**Why?**
- Locked chapters appear recent in chapter lists
- Encourages users to donate for latest content
- Auto-updates without manual date management

---

## 🛠️ Manual Operations

### Check View Status
```bash
# Check manga pending views
cat pending-views.json

# Check chapter pending views
cat pending-chapter-views.json
```

### Force Generate manga.json
```bash
node manga-automation.js generate
```

### Force Update Views
```bash
# Update manga views (ignores threshold)
node manga-automation.js update-views

# Update chapter views (ignores threshold)
node manga-automation.js update-chapters
```

---

## 📝 Important Notes

1. **Only edit `manga-config.json`** manually
2. **All other JSON files** are auto-generated
3. **Chapter folders** must be named with numbers (e.g., `1`, `2.1`, `6.5`)
4. **Images** must follow naming pattern: `Image01.jpg`, `Image02.jpg`, etc.
5. **Locked chapters track views** for analytics
6. **Git history** is used for upload dates (don't delete .git folder)
7. **Thresholds:** 20 for page views, 10 for chapter views

---

## 🔗 Integration with Main Website

This repository provides data to the main website via:

**Main website `manga-config.js`:**
```javascript
const MANGA_LIST = [
  {
    id: 'yarikonda',
    title: '...',
    cover: '...',
    repo: 'YarikondaRenaiGame'  // ← This repo name
  }
];
```

**Data URLs:**
- Manga data: `https://raw.githubusercontent.com/nurananto/YarikondaRenaiGame/main/manga.json`
- Chapter images: `https://raw.githubusercontent.com/nurananto/YarikondaRenaiGame/main/[chapter]/Image01.jpg`

---

## 🎯 Summary

| File | Edit? | Purpose |
|------|-------|---------|
| `manga-config.json` | ✅ Yes | Configuration |
| `manga.json` | ❌ No | Auto-generated data |
| `pending-views.json` | ❌ No | View counter |
| `pending-chapter-views.json` | ❌ No | Chapter view counter |
| `manga-automation.js` | ❌ No | Automation script |
| `manga-automation.yml` | ❌ No | GitHub Actions |
| Chapter folders | ✅ Yes | Add/remove chapters |

**Workflow:** Upload chapters → GitHub Actions → Auto-update everything! 🚀